# ⚡ TimeValue 服务器部署 - 快速操作清单

> **服务器**: 60.205.161.210
> **场景**: 在已有MySQL的服务器上部署Docker化的TimeValue系统

---

## 📋 5分钟快速部署

### 🚀 方式一：一键自动部署（推荐）

```bash
# 1. SSH登录服务器
ssh root@60.205.161.210

# 2. 创建项目目录
mkdir -p /opt/timevalue && cd /opt/timevalue

# 3. 上传项目文件
# 将本地项目文件上传到服务器（使用scp/sftp/git）
# 或使用git克隆
git clone https://github.com/fupukeji/timevalue.git .

# 4. 配置MySQL权限
mysql -u root -p < 配置MySQL权限.sql

# 5. 一键部署
chmod +x 快速部署.sh
./快速部署.sh

# 完成！访问 http://60.205.161.210:5000
```

### 🔧 方式二：手动分步部署

#### Step 1: 上传项目到服务器

```bash
# 本地执行（Windows PowerShell或CMD）
scp -r C:\Users\Administrator\timevalue root@60.205.161.210:/opt/

# 或在服务器上git克隆
ssh root@60.205.161.210
cd /opt
git clone https://github.com/fupukeji/timevalue.git
cd timevalue
```

#### Step 2: 安装Docker环境

```bash
# 安装Docker
sudo yum install -y yum-utils
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
sudo yum install -y docker-ce docker-ce-cli containerd.io
sudo systemctl start docker
sudo systemctl enable docker

# 安装Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 验证安装
docker --version
docker-compose --version
```

#### Step 3: 配置MySQL权限

```bash
# 登录MySQL
mysql -u root -p

# 复制粘贴以下SQL命令
```

```sql
GRANT ALL PRIVILEGES ON timevalue.* TO 'timevalue'@'%' IDENTIFIED BY 'sdA3GThaTaDx3h8S';
ALTER USER 'timevalue'@'%' IDENTIFIED WITH mysql_native_password BY 'sdA3GThaTaDx3h8S';
GRANT ALL PRIVILEGES ON timevalue.* TO 'timevalue'@'172.%.%.%' IDENTIFIED BY 'sdA3GThaTaDx3h8S';
FLUSH PRIVILEGES;
EXIT;
```

检查MySQL配置:

```bash
# 确保MySQL允许远程连接
sudo nano /etc/my.cnf
# 确保有: bind-address = 0.0.0.0

# 重启MySQL
sudo systemctl restart mysqld
```

#### Step 4: 配置防火墙

```bash
# 开放5000端口
sudo firewall-cmd --permanent --add-port=5000/tcp
sudo firewall-cmd --reload
```

#### Step 5: 构建并启动

```bash
cd /opt/timevalue

# 构建Docker镜像
docker-compose -f docker-compose.server.yml build

# 启动服务
docker-compose -f docker-compose.server.yml --env-file .env.docker up -d

# 查看日志
docker-compose -f docker-compose.server.yml logs -f
```

#### Step 6: 验证部署

```bash
# 检查容器状态
docker-compose -f docker-compose.server.yml ps

# 测试健康检查
curl http://localhost:5000/api/health

# 应该返回: {"status":"healthy",...}
```

---

## ✅ 验证清单

部署完成后，逐一检查：

- [ ] Docker已安装: `docker --version`
- [ ] Docker Compose已安装: `docker-compose --version`
- [ ] MySQL用户权限已配置
- [ ] 防火墙端口已开放: `sudo firewall-cmd --list-ports`
- [ ] 容器正在运行: `docker ps | grep timevalue-backend`
- [ ] 健康检查通过: `curl http://localhost:5000/api/health`
- [ ] 可以外网访问: 浏览器打开 `http://60.205.161.210:5000/api/health`

---

## 🛠️ 常用管理命令

```bash
# 查看服务状态
docker-compose -f docker-compose.server.yml ps

# 查看实时日志
docker-compose -f docker-compose.server.yml logs -f

# 重启服务
docker-compose -f docker-compose.server.yml restart

# 停止服务
docker-compose -f docker-compose.server.yml down

# 重新构建并启动
docker-compose -f docker-compose.server.yml build
docker-compose -f docker-compose.server.yml up -d

# 进入容器调试
docker-compose -f docker-compose.server.yml exec backend bash

# 查看资源占用
docker stats timevalue-backend
```

---

## 🔍 快速故障排查

### 问题1: 容器启动失败

```bash
# 查看详细日志
docker-compose -f docker-compose.server.yml logs backend

# 检查配置文件
cat .env.docker

# 测试MySQL连接
mysql -h 127.0.0.1 -u timevalue -psdA3GThaTaDx3h8S timevalue -e "SELECT 1"
```

### 问题2: 无法访问API

```bash
# 检查端口监听
netstat -tulpn | grep :5000

# 检查防火墙
sudo firewall-cmd --list-ports

# 检查容器网络
docker-compose -f docker-compose.server.yml exec backend ping host.docker.internal
```

### 问题3: 数据库连接失败

```bash
# 进入容器测试
docker-compose -f docker-compose.server.yml exec backend bash

# 测试MySQL连接
python -c "
import pymysql
conn = pymysql.connect(
    host='host.docker.internal',
    user='timevalue',
    password='sdA3GThaTaDx3h8S',
    database='timevalue'
)
print('✅ 连接成功')
conn.close()
"
```

---

## 📊 访问信息

部署成功后:

- **后端API**: http://60.205.161.210:5000
- **健康检查**: http://60.205.161.210:5000/api/health
- **管理员账户**: admin / admin123

**⚠️ 重要**: 首次登录后请立即修改管理员密码！

---

## 📚 相关文档

- **[服务器Docker部署指南.md](服务器Docker部署指南.md)** - 完整详细文档（655行）
- **[DOCKER_DEPLOYMENT.md](DOCKER_DEPLOYMENT.md)** - 通用Docker部署文档
- **快速部署.sh** - 自动化部署脚本
- **配置MySQL权限.sql** - MySQL权限配置

---

## 🔒 安全提示

1. **修改默认密码**: 登录后立即修改admin密码
2. **更新密钥**: 生产环境建议生成新的SECRET_KEY和JWT_SECRET_KEY
3. **限制访问**: 配置防火墙仅允许必要IP访问
4. **启用HTTPS**: 考虑配置Nginx + SSL证书

---

## 💡 下一步

部署完成后，建议:

1. 设置自动备份: 查看文档"备份数据库"章节
2. 配置开机自启: 查看文档"Step 7: 设置开机自启"
3. 部署前端: 参考前端部署文档
4. 配置域名: 绑定域名并配置DNS

---

> 🎉 **5分钟快速部署，立即使用！**
>
> 💬 **遇到问题？** 查看 [服务器Docker部署指南.md](服务器Docker部署指南.md) 的故障排查章节
