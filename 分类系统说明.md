# 层级资产分类系统说明

## 概述

TimeValue系统现已升级为**两级分类体系**，更贴近日常资产管理场景，便于用户理解和维护。每个用户的分类数据完全隔离，互不影响。

## 分类结构

### 一级分类（8大类）

1. **固定资产** - 房产、车辆等长期持有的实物资产
2. **金融资产** - 现金、存款、理财等流动金融资产
3. **投资资产** - 股权、债权等投资性资产
4. **无形资产** - 知识产权、品牌等无形资产
5. **教育投资** - 教育培训、技能提升等人力资本投资
6. **收藏品** - 艺术品、古董等收藏投资
7. **数字资产** - 加密货币、NFT等数字资产
8. **其他资产** - 其他类型的资产

### 二级分类示例

#### 1. 固定资产
- 房产
- 车辆
- 设备
- 家具家电

#### 2. 金融资产
- 银行存款
- 理财产品
- 股票
- 债券
- 基金
- 保险

#### 3. 投资资产
- 股权投资
- 债权投资
- 信托
- 私募股权

#### 4. 无形资产
- 知识产权
- 域名
- 软件著作权
- 品牌价值

#### 5. 教育投资
- 学历教育
- 职业培训
- 兴趣爱好
- 子女教育

#### 6. 收藏品
- 艺术品
- 古董
- 珠宝
- 贵金属
- 其他收藏

#### 7. 数字资产
- 加密货币
- NFT
- 游戏资产

#### 8. 其他资产
- 会员权益
- 预付款
- 其他

## 技术特性

### 数据隔离
- 每个用户拥有独立的分类空间
- 用户之间的分类数据完全隔离
- 数据库级别的用户ID关联保证数据安全

### 层级设计
- 支持最多2级分类（一级 + 二级）
- 同一层级下分类名称不能重复
- 支持自定义颜色和图标
- 支持排序顺序设置

### 自动初始化
- 新用户注册时自动创建默认分类
- 现有用户可手动初始化默认分类
- 支持重置分类为默认配置（需确认无关联项目）

## API接口

### 基础操作

#### 获取分类列表
```
GET /api/categories?tree=true
```
- 参数 `tree=true` 返回树形结构
- 参数 `tree=false` 或不传返回平面列表

#### 创建分类
```
POST /api/categories
{
  "name": "分类名称",
  "parent_id": null,  // 一级分类为null，二级分类填父分类ID
  "color": "#1890ff",
  "icon": "home",
  "description": "分类描述",
  "sort_order": 1
}
```

#### 更新分类
```
PUT /api/categories/{id}
{
  "name": "新名称",
  "color": "#52c41a",
  ...
}
```

#### 删除分类
```
DELETE /api/categories/{id}
```
注意：
- 有子分类的分类不能删除
- 有关联项目的分类不能删除

### 高级功能

#### 初始化默认分类
```
POST /api/categories/initialize
```
为当前用户创建默认的两级分类结构

#### 重置分类
```
POST /api/categories/reset
```
⚠️ 危险操作：删除所有现有分类并重新初始化

#### 获取叶子分类
```
GET /api/categories/leaf
```
返回所有没有子分类的分类（通常用于项目选择）

## 前端集成

### 服务方法

```javascript
import { 
  getCategories, 
  initializeCategories,
  resetCategories,
  getLeafCategories
} from '@/services/categories'

// 获取树形分类
const tree = await getCategories({ tree: true })

// 初始化默认分类
await initializeCategories()

// 获取叶子分类（用于项目选择）
const leafCategories = await getLeafCategories()
```

### 显示分类树

```jsx
// 递归渲染分类树
const renderCategoryTree = (categories) => {
  return categories.map(cat => (
    <div key={cat.id}>
      <span style={{ color: cat.color }}>
        {cat.icon} {cat.name} ({cat.project_count})
      </span>
      {cat.children && cat.children.length > 0 && (
        <div style={{ paddingLeft: 20 }}>
          {renderCategoryTree(cat.children)}
        </div>
      )}
    </div>
  ))
}
```

## 数据库结构

```sql
CREATE TABLE categories (
    id INTEGER PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    color VARCHAR(20) DEFAULT '#1890ff',
    icon VARCHAR(50) DEFAULT 'folder',
    description VARCHAR(200),
    sort_order INTEGER DEFAULT 0,
    created_at DATETIME,
    updated_at DATETIME,
    user_id INTEGER NOT NULL,  -- 用户隔离
    parent_id INTEGER,         -- 父分类（NULL为一级分类）
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (parent_id) REFERENCES categories(id),
    UNIQUE (user_id, parent_id, name)  -- 同一用户同一层级下名称唯一
);
```

## 迁移说明

### 现有用户迁移

如果您是现有用户且希望使用新的分类系统：

1. **方式一：保留现有分类**
   - 现有分类会被视为一级分类
   - 可以在现有分类下添加二级分类

2. **方式二：初始化默认分类**
   - 前提：账户中没有任何分类
   - 调用初始化接口自动创建默认分类

3. **方式三：完全重置**
   - 前提：账户中没有任何项目关联到分类
   - 调用重置接口删除现有分类并重新初始化

### 管理工具

后端提供了管理脚本 `test_categories.py`：

```bash
cd backend
python test_categories.py
```

功能：
- 查看分类结构
- 为现有用户批量初始化分类
- 显示分类统计信息

## 最佳实践

1. **项目应关联到二级分类**
   - 一级分类用于整体分组
   - 二级分类才是具体的资产类型

2. **合理使用颜色**
   - 同一一级分类下的二级分类使用相近色系
   - 有助于视觉识别和数据分析

3. **自定义扩展**
   - 可以在默认分类基础上添加自己的分类
   - 建议保持两级结构，便于管理

4. **数据维护**
   - 定期检查未使用的分类
   - 删除前确保没有项目关联

## 注意事项

⚠️ **删除限制**
- 有子分类的分类不能直接删除
- 有项目关联的分类不能删除
- 需先转移或删除关联内容

⚠️ **数据隔离**
- 所有分类操作都会自动关联到当前登录用户
- 无法访问其他用户的分类数据

⚠️ **层级限制**
- 最多支持2级分类（一级+二级）
- 不支持3级及以上层级

## 常见问题

**Q: 新用户注册时会自动创建分类吗？**
A: 是的，新用户注册时会自动创建完整的默认分类体系。

**Q: 现有用户如何获得默认分类？**
A: 如果账户中没有分类，可以调用初始化接口创建默认分类。

**Q: 能否修改默认分类？**
A: 可以，默认分类创建后可以自由修改名称、颜色、图标等。

**Q: 能否添加自己的分类？**
A: 可以，在默认分类基础上可以添加自定义的一级和二级分类。

**Q: 删除一级分类会怎样？**
A: 如果一级分类下有二级分类，需要先删除或转移所有二级分类。

**Q: 多个用户的分类会互相影响吗？**
A: 不会，每个用户的分类数据完全独立，互不影响。
